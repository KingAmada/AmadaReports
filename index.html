<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amada Luxury Stays | Management Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #FF385C; 
            --primary-hover: #E31C5F;
            --dark: #222222;
            --gray: #717171;
            --light-gray: #F3F4F6;
            --white: #FFFFFF;
            --success: #008a05;
            --warning: #faad14;
            --danger: #dc3545;
            --blue: #0066cc;
            --bg-gradient: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            --glass: rgba(255, 255, 255, 0.9);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.02);
            --shadow-md: 0 10px 30px rgba(0,0,0,0.08);
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.12);
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background: var(--bg-gradient);
            color: var(--dark);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 80px; 
        }

        /* --- Header & Nav --- */
        header {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: var(--glass-border);
            padding: 15px 0;
            box-shadow: var(--shadow-sm);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .role-toggle {
            background: var(--light-gray);
            border-radius: 30px;
            padding: 5px;
            display: flex;
            gap: 5px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .role-btn {
            border: none;
            background: transparent;
            padding: 8px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .role-btn:hover { color: var(--dark); }

        .role-btn.active {
            background: var(--white);
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: scale(1.02);
            font-weight: 600;
        }
        
        .sync-indicator {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray);
            font-weight: 500;
            background: rgba(255,255,255,0.5);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; transition: background 0.3s; }
        .sync-dot.online { background: var(--success); box-shadow: 0 0 8px rgba(0, 138, 5, 0.4); }
        .sync-dot.syncing { background: var(--warning); animation: pulse-yellow 1s infinite; }
        .sync-dot.offline { background: var(--danger); }

        @keyframes pulse-yellow { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

        /* --- Main Layout --- */
        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .dashboard-wrapper { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- KPI Cards --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .kpi-card {
            background: var(--white);
            padding: 25px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
        .kpi-card.highlight::before { background: var(--primary); }
        .kpi-card.success::before { background: var(--success); }
        .kpi-card.warning::before { background: var(--warning); }

        .kpi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .kpi-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .highlight .kpi-icon { background: rgba(255, 56, 92, 0.1); color: var(--primary); }
        .success .kpi-icon { background: rgba(0, 138, 5, 0.1); color: var(--success); }
        .warning .kpi-icon { background: rgba(250, 173, 20, 0.1); color: var(--warning); }

        .kpi-title { font-size: 0.85rem; color: var(--gray); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .kpi-value { font-size: 2rem; font-weight: 700; color: var(--dark); margin: 5px 0; }
        .kpi-sub { font-size: 0.85rem; color: var(--gray); display: flex; align-items: center; gap: 5px; }

        /* --- Accounting / Management Styles --- */
        .accounts-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }

        .panel { 
            background: var(--white); padding: 30px; border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-md); border: 1px solid rgba(0,0,0,0.02);
        }
        
        .expense-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; color: var(--gray); margin-bottom: 8px; font-weight: 600; }
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gray); transition: 0.3s; }
        
        .styled-input, .styled-select {
            width: 100%; padding: 14px 14px 14px 45px; 
            border: 2px solid #eee; border-radius: var(--radius-md); 
            font-family: 'Poppins'; font-size: 0.95rem; background: #fafafa;
            transition: all 0.3s ease;
        }
        .styled-input:focus, .styled-select:focus {
            border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px rgba(255, 56, 92, 0.1);
        }
        .input-wrapper:focus-within i { color: var(--primary); }

        .profit-summary {
            background: var(--dark); color: white; padding: 35px; border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-lg); display: flex; flex-direction: column; justify-content: center;
            position: relative; overflow: hidden;
        }
        .profit-summary::after {
            content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%; pointer-events: none;
        }
        .profit-row { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); align-items: center; }
        .profit-label { font-size: 0.95rem; opacity: 0.8; }
        .profit-val { font-size: 1.1rem; font-weight: 500; }
        .net-profit { font-size: 2.5rem; font-weight: 700; color: var(--success); text-shadow: 0 2px 10px rgba(0,255,0,0.2); margin-top: 10px; }
        .net-loss { color: var(--primary); text-shadow: 0 2px 10px rgba(255, 56, 92, 0.2); }

        /* --- Controls Bar --- */
        .controls-bar {
            background: var(--white); padding: 20px 30px; border-radius: var(--radius-lg); display: flex;
            gap: 20px; align-items: center; flex-wrap: wrap; margin-bottom: 40px; box-shadow: var(--shadow-sm);
        }
        
        /* --- Tabs --- */
        .mgmt-tabs { 
            display: flex; gap: 15px; margin-bottom: 25px; 
            overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 10px;
        }
        .mgmt-tab { 
            padding: 12px 25px; border-radius: var(--radius-md); background: var(--white); cursor: pointer; 
            font-weight: 600; font-size: 0.9rem; transition: all 0.3s; white-space: nowrap;
            color: var(--gray); border: 1px solid #eee; display: flex; align-items: center; gap: 8px;
        }
        .mgmt-tab:hover { background: var(--light-gray); transform: translateY(-2px); }
        .mgmt-tab.active { background: var(--dark); color: white; border-color: var(--dark); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* --- Table --- */
        .table-container { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid #eee; }
        .expense-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .expense-table th { text-align: left; padding: 18px; background: #f9fafb; color: var(--gray); font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        .expense-table td { padding: 18px; border-bottom: 1px solid #eee; transition: background 0.2s; }
        .expense-table tr:hover td { background: #fafafa; }
        .expense-table tr:last-child td { border-bottom: none; }

        /* --- Property Sections --- */
        .location-section { margin-bottom: 60px; }
        .location-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;
            padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;
        }
        .location-title { font-size: 1.6rem; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 10px; }

        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
        .property-card {
            background: var(--white); border-radius: var(--radius-lg); overflow: hidden;
            box-shadow: var(--shadow-sm); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            position: relative; border: 1px solid rgba(0,0,0,0.02); display: flex; flex-direction: column;
        }
        .property-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-8px); }
        
        .status-badge { 
            position: absolute; top: 15px; right: 15px; padding: 6px 12px; border-radius: 20px; 
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .status-avail { background: var(--success); }
        .status-booked { background: var(--primary); }

        .card-img-placeholder {
            height: 160px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;
            color: #ddd; font-size: 3rem;
        }

        .card-content { padding: 25px; flex-grow: 1; display: flex; flex-direction: column; }
        .prop-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 8px; color: var(--dark); }
        .prop-loc { font-size: 0.85rem; color: var(--gray); margin-bottom: 15px; display: flex; align-items: center; gap: 5px; }
        .prop-price { font-size: 1.25rem; color: var(--primary); font-weight: 700; margin-bottom: 20px; }
        .prop-price span { font-size: 0.9rem; color: var(--gray); font-weight: 400; }

        .action-btn {
            width: 100%; padding: 14px; margin-top: auto; border: none; border-radius: var(--radius-md);
            font-weight: 600; font-family: 'Poppins', sans-serif; cursor: pointer; transition: all 0.3s;
            text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .action-btn:active { transform: scale(0.98); }

        .btn-book { background: var(--dark); color: white; }
        .btn-book:hover { background: black; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .btn-checkout { background: white; border: 2px solid #eee; color: var(--dark); }
        .btn-checkout:hover { border-color: var(--dark); background: var(--dark); color: white; }
        
        .btn-save { 
            background: linear-gradient(135deg, var(--success), #00a806); color: white; 
            font-size: 1rem; margin-top: 25px; box-shadow: 0 5px 15px rgba(0,138,5,0.3);
        }
        .btn-save:hover { box-shadow: 0 8px 20px rgba(0,138,5,0.4); transform: translateY(-2px); }

        /* --- Modal --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.3s;
        }
        .modal.show { opacity: 1; }
        .modal-content {
            background: white; padding: 40px; border-radius: 25px; width: 95%; max-width: 500px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25); transform: scale(0.95) translateY(20px); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 90vh; overflow-y: auto; position: relative;
        }
        .modal.show .modal-content { transform: scale(1) translateY(0); }
        
        .close-modal {
            position: absolute; top: 20px; right: 20px; background: #f0f0f0; border: none;
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex;
            align-items: center; justify-content: center; color: var(--gray); transition: 0.2s;
        }
        .close-modal:hover { background: #e0e0e0; color: var(--dark); transform: rotate(90deg); }

        .total-display { 
            background: #f8f9fa; padding: 20px; border-radius: var(--radius-md); margin-bottom: 25px; 
            text-align: center; border: 2px dashed #e0e0e0; 
        }
        
        /* Spinner */
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Map Container */
        .map-container {
            width: 100%; height: 500px; border-radius: var(--radius-lg); overflow: hidden; margin-top: 25px;
            box-shadow: var(--shadow-md); border: 4px solid white; z-index: 1;
        }
        
        /* Search Bar */
        .search-container { position: relative; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .search-container input {
            width: 100%; padding: 12px 12px 12px 45px; border-radius: 30px; border: 1px solid #ddd;
            font-family: 'Poppins'; font-size: 0.9rem; box-shadow: var(--shadow-sm); transition: 0.3s;
        }
        .search-container input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(255,56,92,0.1); }
        .search-container i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--gray); }

        /* --- Notification Toast --- */
        #notification-container {
            position: fixed; top: 20px; right: 20px; z-index: 3000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .notification {
            background: white; padding: 16px 24px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 15px;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); min-width: 300px; max-width: 90vw;
            border-left: 6px solid #ccc; pointer-events: all;
            font-size: 0.95rem; font-weight: 500;
        }
        .notification i { font-size: 1.2rem; }
        .notification.success { border-left-color: var(--success); color: var(--success); }
        .notification.error { border-left-color: var(--danger); color: var(--danger); }
        .notification.info { border-left-color: var(--blue); color: var(--blue); }
        
        @keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(120%); opacity: 0; } }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 768px) {
            .nav-container { flex-direction: column; align-items: flex-start; gap: 15px; padding: 10px 20px; }
            .brand { width: 100%; justify-content: center; }
            .role-toggle { width: 100%; justify-content: space-between; overflow-x: auto; }
            .role-btn { flex: 1; justify-content: center; white-space: nowrap; padding: 8px 15px; font-size: 0.85rem; }
            .sync-indicator { width: 100%; justify-content: center; background: transparent; border: none; }

            .accounts-grid { grid-template-columns: 1fr; gap: 20px; }
            .charts-grid { grid-template-columns: 1fr; gap: 20px; }
            .expense-form-grid { grid-template-columns: 1fr; }
            
            .modal-content { width: 92%; padding: 25px; margin: 0 4%; }
            .controls-bar { flex-direction: column; align-items: stretch; padding: 20px; }
            .control-group { width: 100%; }
            
            .mgmt-tabs { margin: 0 -20px 20px -20px; padding: 0 20px 10px 20px; }
            .location-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .search-container { max-width: 100%; }
            
            .map-container { height: 300px; }
        }
    </style>
</head>
<body>

<header>
    <div class="nav-container">
        <div class="brand"><i class="fa-solid fa-crown"></i> Amada <span style="font-weight:300">Stays</span></div>
        <div class="role-toggle">
            <button id="btnStaff" class="role-btn active" onclick="app.requestRole('staff')"><i class="fa-solid fa-bell-concierge"></i> Staff</button>
            <button id="btnMgmt" class="role-btn" onclick="app.requestRole('management')"><i class="fa-solid fa-briefcase"></i> Management</button>
            <button id="btnChair" class="role-btn" onclick="app.requestRole('chairman')"><i class="fa-solid fa-user-tie"></i> Chairman</button>
        </div>
        <div class="sync-indicator">
            <div id="syncDot" class="sync-dot"></div>
            <span id="syncStatus">Cloud Idle</span>
        </div>
    </div>
</header>

<div class="container" id="appContainer"></div>
<div id="notification-container"></div>

<div id="pinModal" class="modal">
    <div class="modal-content" style="max-width:380px; text-align:center;">
        <button class="close-modal" onclick="app.closeModal()"><i class="fa-solid fa-times"></i></button>
        <div style="margin-bottom:20px; color:var(--dark); font-size:2rem;"><i class="fa-solid fa-lock"></i></div>
        <h3 id="pinTitle" style="margin:0 0 10px 0;">Access Required</h3>
        <p style="font-size:0.9rem; color:var(--gray); margin-bottom:25px;">Please enter your 4-digit security PIN to access this dashboard.</p>
        <div class="input-wrapper">
            <input type="password" id="rolePinInput" class="styled-input" placeholder="••••" style="text-align:center; font-size:1.8rem; letter-spacing:12px; padding-left:14px;">
        </div>
        <button class="action-btn btn-save" style="margin-top:25px; background:var(--dark);" onclick="app.verifyPin()">Unlock Dashboard</button>
    </div>
</div>

<div id="targetModal" class="modal">
    <div class="modal-content" style="max-width:450px;">
        <button class="close-modal" onclick="app.closeModal()"><i class="fa-solid fa-times"></i></button>
        <h3 style="margin-top:0; display:flex; align-items:center; gap:10px;"><i class="fa-solid fa-bullseye" style="color:var(--primary)"></i> Set Target</h3>
        
        <div style="margin-top:25px;">
            <div class="input-group">
                <label>Target Location</label>
                <div class="input-wrapper">
                    <i class="fa-solid fa-location-dot"></i>
                    <select id="targetLoc" class="styled-select">
                        <option value="Hilltop">Hilltop</option>
                        <option value="Jahi">Jahi</option>
                        <option value="The White House">The White House</option>
                    </select>
                </div>
            </div>
            <div class="input-group">
                <label>For Month</label>
                <div class="input-wrapper">
                    <i class="fa-regular fa-calendar"></i>
                    <input type="month" id="targetMonth" class="styled-input">
                </div>
            </div>
            <div class="input-group">
                <label>Target Amount (₦)</label>
                <div class="input-wrapper">
                    <i class="fa-solid fa-naira-sign"></i>
                    <input type="number" id="targetVal" class="styled-input" placeholder="e.g. 15,000,000">
                </div>
            </div>
            <button class="action-btn btn-save" onclick="app.saveTarget()"><i class="fa-solid fa-check"></i> Save Target</button>
        </div>
    </div>
</div>

<div id="bookingModal" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="app.closeModal()"><i class="fa-solid fa-times"></i></button>
        <h3 style="margin-top:0; display:flex; align-items:center; gap:10px;"><i class="fa-solid fa-calendar-check" style="color:var(--primary)"></i> New Booking</h3>
        
        <div id="modalPropInfo" style="background:#f8f9fa; padding:15px; border-radius:12px; margin-bottom:20px; border-left:4px solid var(--primary);">
            <div style="font-weight:600; font-size:1.1rem;" id="modalPropName">Property Name</div>
            <div style="color:var(--gray); font-size:0.9rem;" id="modalPropPrice">Price</div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div class="input-group">
                <label>Check-In</label>
                <div class="input-wrapper"><i class="fa-regular fa-calendar-plus"></i><input type="date" id="checkInDate" class="styled-input" onchange="app.calcTotal()"></div>
            </div>
            <div class="input-group">
                <label>Check-Out</label>
                <div class="input-wrapper"><i class="fa-regular fa-calendar-minus"></i><input type="date" id="checkOutDate" class="styled-input" onchange="app.calcTotal()"></div>
            </div>
        </div>

        <div class="input-group">
            <label>Guest Full Name</label>
            <div class="input-wrapper"><i class="fa-regular fa-user"></i><input type="text" id="guestName" class="styled-input" placeholder="e.g. Mr. John Doe"></div>
        </div>

        <div class="total-display">
            <div style="font-size: 0.85rem; color: var(--gray); text-transform: uppercase; font-weight:600;">Total Estimate (<span id="nightCount">1</span> Nights)</div>
            <div class="total-amount" id="modalTotal" style="font-size:2rem; font-weight:700; color:var(--dark); margin-top:5px;">₦0</div>
        </div>

        <div class="input-group">
            <label>Actual Amount Paid</label>
            <div class="input-wrapper"><i class="fa-solid fa-wallet"></i><input type="number" id="actualPaid" class="styled-input"></div>
        </div>

        <button id="btnConfirm" class="action-btn btn-save" onclick="app.confirmBooking()"><i class="fa-solid fa-paper-plane"></i> Confirm & Sync</button>
    </div>
</div>

<script>
    class AmadaApp {
        constructor() {
            // *** CRITICAL: PASTE YOUR DEPLOYED GOOGLE SCRIPT URL HERE ***
            this.googleScriptUrl = "PASTE_YOUR_WEB_APP_URL_HERE";
            
            this.role = 'staff';
            this.pendingRole = null;
            this.activeMgmtTab = 'pl'; 
            this.activeStaffTab = 'ops'; 
            
            // *** CRITICAL: MAP YOUR PHYSICAL TUYA LOCK IDS HERE ***
            // Example: 'h_4bed_1': 'eb583948754...',
            this.LOCK_MAPPING = {
                'h_4bed_1': 'REPLACE_WITH_TUYA_DEVICE_ID',
                'h_1bed_1': 'REPLACE_WITH_TUYA_DEVICE_ID',
                'j_3bed_1': 'REPLACE_WITH_TUYA_DEVICE_ID'
                // Add all your units here
            };

            this.rolePins = { 'management': '4444', 'chairman': '8888' };
            this.filters = { location: 'all', status: 'all' };
            this.managementFilter = 'all'; 
            this.sortBy = 'default';
            this.searchQuery = '';

            const today = new Date();
            this.dateFrom = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            this.dateTo = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0]; 

            this.reportBaselines = {
                'Hilltop': { salary: 694000, sundry: 749000 },
                'Jahi': { salary: 675000, sundry: 1096000 },
                'The White House': { salary: 522000, sundry: 453070 }
            };

            this.targets = {}; 
            this.inventory = this.getInitialInventory();
            this.transactions = []; 
            this.expenditures = []; 
            this.refunds = [];

            this.init();
        }

        async init() {
            this.loadLocalData();
            this.render();
            this.setupPinEnter();
            await this.syncFromCloud();
        }

        showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const div = document.createElement('div');
            div.className = `notification ${type}`;
            
            let icon = '<i class="fa-solid fa-circle-info"></i>';
            if(type === 'success') icon = '<i class="fa-solid fa-circle-check"></i>';
            if(type === 'error') icon = '<i class="fa-solid fa-circle-exclamation"></i>';

            div.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(div);

            setTimeout(() => {
                div.style.animation = 'slideOut 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
                setTimeout(() => div.remove(), 400);
            }, 4000);
        }

        setupPinEnter() {
            const pinInput = document.getElementById('rolePinInput');
            if (pinInput) {
                pinInput.addEventListener("keypress", (event) => {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        this.verifyPin();
                    }
                });
            }
        }

        getInitialInventory() {
            let inv = [];
            // Katampe (Hilltop)
            for(let i=1; i<=3; i++) inv.push({ id: `h_4bed_${i}`, loc: 'Hilltop', name: `4 Bed Duplex ${i}`, price: 250000, status: 'available' });
            for(let i=1; i<=3; i++) inv.push({ id: `h_1bed_${i}`, loc: 'Hilltop', name: `1 Bed Apt ${i}`, price: 80000, status: 'available' });
            // Jahi
            for(let i=1; i<=2; i++) inv.push({ id: `j_3bed_${i}`, loc: 'Jahi', name: `3 Bed Apt ${i}`, price: 150000, status: 'available' });
            for(let i=1; i<=4; i++) inv.push({ id: `j_2bed_${i}`, loc: 'Jahi', name: `2 Bed Apt ${i}`, price: 120000, status: 'available' });
            for(let i=1; i<=2; i++) inv.push({ id: `j_1bed_${i}`, loc: 'Jahi', name: `1 Bed Apt ${i}`, price: 70000, status: 'available' });
            // Gwarinpa (The White House)
            for(let i=1; i<=3; i++) inv.push({ id: `w_studio_${i}`, loc: 'The White House', name: `Studio ${i}`, price: 40000, status: 'available' });
            for(let i=1; i<=3; i++) inv.push({ id: `w_1bed_${i}`, loc: 'The White House', name: `1 Bed Apt ${i}`, price: 50000, status: 'available' });
            return inv;
        }

        loadLocalData() {
            const keys = ['amadaInventory', 'amadaTransactions', 'amadaExpenditures', 'amadaTargets', 'amadaRefunds'];
            keys.forEach(k => {
                const val = localStorage.getItem(k);
                if(val) this[k.replace('amada', '').toLowerCase()] = JSON.parse(val);
            });
        }

        saveLocalData() {
            localStorage.setItem('amadaInventory', JSON.stringify(this.inventory));
            localStorage.setItem('amadaTransactions', JSON.stringify(this.transactions));
            localStorage.setItem('amadaExpenditures', JSON.stringify(this.expenditures));
            localStorage.setItem('amadaTargets', JSON.stringify(this.targets));
            localStorage.setItem('amadaRefunds', JSON.stringify(this.refunds));
            this.render();
            this.syncToCloud(); 
        }

        async syncFromCloud() {
            this.updateSyncUI('syncing');
            try {
                const res = await fetch(this.googleScriptUrl);
                if (!res.ok) throw new Error(`Server Error (${res.status})`);
                
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.message);

                if (data.inventory?.length > 0) this.inventory = data.inventory;
                if (data.transactions) this.transactions = data.transactions;
                if (data.expenditures) this.expenditures = data.expenditures;
                if (data.targets) this.targets = data.targets;
                if (data.refunds) this.refunds = data.refunds;
                
                this.updateSyncUI('online');
            } catch (e) { 
                this.updateSyncUI('offline');
                console.error("Sync Failed:", e);
                // Silent fail on load, robust error on action
            }
        }

        async syncToCloud() {
            this.updateSyncUI('syncing');
            const payload = { 
                inventory: this.inventory, 
                transactions: this.transactions, 
                expenditures: this.expenditures, 
                targets: this.targets, 
                refunds: this.refunds
            };
            try {
                const res = await fetch(this.googleScriptUrl, { method: 'POST', body: JSON.stringify(payload) });
                if (!res.ok) throw new Error(`Server Error (${res.status})`);
                
                const json = await res.json();
                if (json.status === 'success') {
                    this.updateSyncUI('online');
                } else {
                    throw new Error(json.message || "Unknown error");
                }
            } catch (e) { 
                this.updateSyncUI('offline');
                this.showNotification(`Data Save Failed: ${e.message}`, 'error');
            }
        }

        render() {
            const container = document.getElementById('appContainer');
            container.innerHTML = '';
            
            // Apply Fade In Animation
            container.style.animation = 'none';
            container.offsetHeight; /* trigger reflow */
            container.style.animation = 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)';

            if (this.role === 'chairman') this.renderChairmanDashboard(container);
            else if (this.role === 'management') this.renderManagementView(container);
            else this.renderStaffView(container);
            
            this.setupPinEnter();
        }

        // --- RENDER FUNCTIONS --- //

        renderManagementView(container) {
            let scopeProps = [...this.inventory];
            let targetLocs = Object.keys(this.reportBaselines);

            if (this.managementFilter.startsWith('loc:')) {
                const loc = this.managementFilter.split('loc:')[1];
                scopeProps = this.inventory.filter(i => i.loc === loc);
                targetLocs = [loc];
            } else if (this.managementFilter.startsWith('unit:')) {
                const unitId = this.managementFilter.split('unit:')[1];
                const unit = this.inventory.find(i => i.id === unitId);
                scopeProps = unit ? [unit] : [];
                targetLocs = unit ? [unit.loc] : [];
            }

            const d1 = new Date(this.dateFrom);
            const d2 = new Date(this.dateTo);
            const daysDiff = Math.max(1, (d2 - d1) / 86400000);
            const factor = daysDiff / 30; 

            const grossRevenue = this.transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= d1 && tDate <= d2 && scopeProps.some(p => p.id === t.propId);
            }).reduce((s, t) => s + (t.amount || 0), 0);

            const totalRefunds = this.refunds.filter(r => {
                const rDate = new Date(r.date);
                return rDate >= d1 && rDate <= d2;
            }).reduce((s, r) => s + parseFloat(r.amount), 0);

            const netRevenue = grossRevenue - totalRefunds;
            const tax = netRevenue * 0.125;
            const maintenance = netRevenue * 0.05; 
            const rentExpense = scopeProps.reduce((s, p) => s + (1500000/365 * daysDiff), 0);
            
            let baselineSalary = 0;
            let baselineSundry = 0;

            targetLocs.forEach(l => {
                if(this.reportBaselines[l]) {
                    const subRatio = this.managementFilter.startsWith('unit:') ? (1 / this.inventory.filter(i => i.loc === l).length) : 1;
                    baselineSalary += this.reportBaselines[l].salary * factor * subRatio;
                    baselineSundry += this.reportBaselines[l].sundry * factor * subRatio;
                }
            });

            const additionalExp = this.expenditures.filter(e => {
                const eDate = new Date(e.date);
                const scopeMatch = this.managementFilter === 'all' || (this.managementFilter.startsWith('loc:') && e.location === this.managementFilter.split('loc:')[1]) || (this.managementFilter.startsWith('unit:') && e.unitId === this.managementFilter.split('unit:')[1]);
                return eDate >= d1 && eDate <= d2 && scopeMatch;
            }).reduce((s, e) => s + parseFloat(e.amount), 0);

            const totalSundryActual = baselineSundry + additionalExp;
            const netProfit = netRevenue - tax - maintenance - rentExpense - baselineSalary - totalSundryActual;

            let dropdownHtml = `<option value="all">All Locations (Consolidated)</option>`;
            Object.keys(this.reportBaselines).forEach(loc => {
                dropdownHtml += `<optgroup label="${loc}">`;
                dropdownHtml += `<option value="loc:${loc}" ${this.managementFilter === `loc:${loc}` ? 'selected' : ''}>View ${loc} Total</option>`;
                this.inventory.filter(u => u.loc === loc).forEach(u => {
                    dropdownHtml += `<option value="unit:${u.id}" ${this.managementFilter === `unit:${u.id}` ? 'selected' : ''}>-- ${u.name}</option>`;
                });
                dropdownHtml += `</optgroup>`;
            });

            container.innerHTML = `
                <div class="dashboard-wrapper">
                    <div class="controls-bar" style="justify-content:space-between;">
                        <div>
                            <h2 style="margin:0; font-size:1.8rem;">Management Hub</h2>
                            <p style="margin:5px 0 0; font-size:0.9rem; color:var(--gray);">Financial Overview & Operations</p>
                        </div>
                        <div style="display:flex; gap:15px; flex-wrap:wrap;">
                            <div class="input-wrapper">
                                <i class="fa-regular fa-calendar"></i>
                                <input type="date" class="styled-input" value="${this.dateFrom}" onchange="app.updateDate('from', this.value)" style="width:auto;">
                            </div>
                            <div class="input-wrapper">
                                <i class="fa-regular fa-calendar"></i>
                                <input type="date" class="styled-input" value="${this.dateTo}" onchange="app.updateDate('to', this.value)" style="width:auto;">
                            </div>
                            <div class="input-wrapper">
                                <i class="fa-solid fa-filter"></i>
                                <select class="styled-select" onchange="app.updateMgmtFilter(this.value)" style="width:auto;">${dropdownHtml}</select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mgmt-tabs">
                        <div class="mgmt-tab ${this.activeMgmtTab === 'pl' ? 'active' : ''}" onclick="app.setMgmtTab('pl')"><i class="fa-solid fa-file-invoice-dollar"></i> P&L Statement</div>
                        <div class="mgmt-tab ${this.activeMgmtTab === 'expenditure' ? 'active' : ''}" onclick="app.setMgmtTab('expenditure')"><i class="fa-solid fa-receipt"></i> Operations Recording</div>
                    </div>

                    ${this.activeMgmtTab === 'pl' ? `
                    <div class="accounts-grid">
                        <div class="panel">
                            <h3><i class="fa-solid fa-chart-pie" style="color:var(--primary)"></i> Monthly Baseline Details</h3>
                            <div style="margin-top:25px;">
                                <div class="profit-row"><span><i class="fa-solid fa-users-gear" style="color:#aaa; margin-right:8px;"></i> Salaries (Allocated)</span><span>${this.formatCurrency(baselineSalary)}</span></div>
                                <div class="profit-row"><span><i class="fa-solid fa-box-open" style="color:#aaa; margin-right:8px;"></i> Sundry (Allocated)</span><span>${this.formatCurrency(baselineSundry)}</span></div>
                                <div class="profit-row"><span><i class="fa-solid fa-building" style="color:#aaa; margin-right:8px;"></i> Rent (Amortized)</span><span>${this.formatCurrency(rentExpense)}</span></div>
                            </div>
                        </div>
                        <div class="profit-summary">
                            <div style="font-size:1.2rem; font-weight:600; margin-bottom:25px; opacity:0.9; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:10px;">Profit & Loss Statement</div>
                            <div class="profit-row"><span>Gross Revenue</span><span>${this.formatCurrency(grossRevenue)}</span></div>
                            <div class="profit-row"><span>Less: Refunds</span><span style="color:#ff6b6b">-${this.formatCurrency(totalRefunds)}</span></div>
                            <div class="profit-row" style="border-top:1px dashed rgba(255,255,255,0.2); padding-top:10px; margin-bottom:15px; font-weight:600; font-size:1.1rem;">
                                <span>Net Revenue</span><span>${this.formatCurrency(netRevenue)}</span>
                            </div>
                            <div class="profit-row"><span>Less: VAT (12.5%)</span><span style="color:#ff6b6b">-${this.formatCurrency(tax)}</span></div>
                            <div class="profit-row"><span>Less: Maint (5%)</span><span style="color:#ff6b6b">-${this.formatCurrency(maintenance)}</span></div>
                            <div class="profit-row"><span>Less: Rent</span><span style="color:#ff6b6b">-${this.formatCurrency(rentExpense)}</span></div>
                            <div class="profit-row"><span>Less: Total Sundry</span><span style="color:#ff6b6b">-${this.formatCurrency(totalSundryActual)}</span></div>
                            <div class="profit-row"><span>Less: Salaries</span><span style="color:#ff6b6b">-${this.formatCurrency(baselineSalary)}</span></div>
                            <div style="margin-top:20px; border-top:2px solid rgba(255,255,255,0.2); padding-top:15px;">
                                <div class="profit-label">Net Profit / Loss</div>
                                <div class="${netProfit >= 0 ? 'net-profit' : 'net-profit net-loss'}">${this.formatCurrency(netProfit)}</div>
                            </div>
                        </div>
                    </div>` : this.renderExpenditureTab()}
                </div>`;
        }

        renderChairmanDashboard(container) {
            let data = [...this.inventory];
            if (this.filters.location !== 'all') data = data.filter(i => i.loc === this.filters.location);
            if (this.sortBy === 'price_high') data.sort((a,b) => b.price - a.price);
            else if (this.sortBy === 'price_low') data.sort((a,b) => a.price - b.price);

            const grossRev = this.transactions.filter(t => {
                const tDate = new Date(t.date);
                const d1 = new Date(this.dateFrom);
                const d2 = new Date(this.dateTo);
                const prop = this.inventory.find(p => p.id === t.propId);
                const locMatch = this.filters.location === 'all' || (prop && prop.loc === this.filters.location);
                return tDate >= d1 && tDate <= d2 && locMatch;
            }).reduce((s, t) => s + (t.amount || 0), 0);

            const refunds = this.refunds.filter(r => {
                const rDate = new Date(r.date);
                return rDate >= new Date(this.dateFrom) && rDate <= new Date(this.dateTo);
            }).reduce((s, r) => s + parseFloat(r.amount), 0);

            const netRev = grossRev - refunds;
            const rangeMonth = this.dateFrom.substring(0, 7);
            let totalTarget = 0;
            const locs = [...new Set(this.inventory.map(i => i.loc))];
            
            locs.forEach(l => {
                if(this.filters.location === 'all' || this.filters.location === l) {
                    const key = `${l}_${rangeMonth}`;
                    totalTarget += (this.targets[key] || 0);
                }
            });

            const occCount = data.filter(i => i.status === 'occupied').length;
            const occupancyRate = data.length ? Math.round((occCount / data.length) * 100) : 0;
            
            container.innerHTML = `
                <div class="dashboard-wrapper">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                        <div>
                            <h2 style="margin:0; font-size:1.8rem;">Chairman's Dashboard</h2>
                            <p style="color:var(--gray); margin:5px 0 0;">Executive Overview</p>
                        </div>
                        <button class="action-btn" style="width:auto; padding:12px 25px; background:var(--dark); color:white;" onclick="app.openTargetModal()">
                            <i class="fa-solid fa-bullseye"></i> Set Targets
                        </button>
                    </div>
                    
                    <div class="controls-bar">
                        <div class="control-group">
                            <label>From</label>
                            <div class="input-wrapper"><i class="fa-regular fa-calendar"></i><input type="date" class="styled-input" value="${this.dateFrom}" onchange="app.updateDate('from', this.value)"></div>
                        </div>
                        <div class="control-group">
                            <label>To</label>
                            <div class="input-wrapper"><i class="fa-regular fa-calendar"></i><input type="date" class="styled-input" value="${this.dateTo}" onchange="app.updateDate('to', this.value)"></div>
                        </div>
                        <div class="control-group">
                            <label>Location</label>
                            <div class="input-wrapper"><i class="fa-solid fa-location-dot"></i>
                            <select class="styled-select" onchange="app.updateFilter('location', this.value)">
                                <option value="all">All Locations</option>
                                ${locs.map(l => `<option value="${l}" ${this.filters.location === l ? 'selected' : ''}>${l}</option>`).join('')}
                            </select></div>
                        </div>
                    </div>

                    <div class="kpi-grid">
                        <div class="kpi-card highlight">
                            <div class="kpi-header"><div class="kpi-title">Net Revenue</div><div class="kpi-icon"><i class="fa-solid fa-chart-line"></i></div></div>
                            <div><div class="kpi-value">${this.formatCurrency(netRev)}</div><div class="kpi-sub">Target: ${this.formatCurrency(totalTarget)}</div></div>
                        </div>
                        <div class="kpi-card success">
                            <div class="kpi-header"><div class="kpi-title">Active Units</div><div class="kpi-icon"><i class="fa-solid fa-house-chimney"></i></div></div>
                            <div><div class="kpi-value">${data.length}</div><div class="kpi-sub">Total Portfolio</div></div>
                        </div>
                        <div class="kpi-card warning">
                            <div class="kpi-header"><div class="kpi-title">Occupancy</div><div class="kpi-icon"><i class="fa-solid fa-percent"></i></div></div>
                            <div><div class="kpi-value">${occupancyRate}%</div><div class="kpi-sub">${occCount} Occupied / ${data.length - occCount} Vacant</div></div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="panel">
                            <h3 style="margin-top:0; font-size:1rem; color:var(--gray);"><i class="fa-solid fa-chart-column"></i> Revenue Distribution</h3>
                            <canvas id="revChart"></canvas>
                        </div>
                        <div class="panel">
                             <h3 style="margin-top:0; font-size:1rem; color:var(--gray);"><i class="fa-solid fa-chart-pie"></i> Occupancy Status</h3>
                            <canvas id="occChart"></canvas>
                        </div>
                    </div>

                    <div class="panel">
                        <h3 style="margin-top:0;"><i class="fa-solid fa-map-location-dot" style="color:var(--primary)"></i> Property Map Overview</h3>
                        <div id="chairMap" class="map-container"></div>
                    </div>
                </div>`;
            
            this.renderCharts();
            setTimeout(() => this.initMap('chairMap'), 500);
        }

        renderCharts() {
            setTimeout(() => {
                const labels = Object.keys(this.reportBaselines);
                const dataRev = labels.map(l => {
                   return this.transactions.filter(t => {
                        const p = this.inventory.find(inv => inv.id === t.propId);
                        return p && p.loc === l;
                   }).reduce((s,t)=>s+(t.amount||0),0);
                });

                new Chart(document.getElementById('revChart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{ label: 'Gross Revenue (₦)', data: dataRev, backgroundColor: '#FF385C', borderRadius: 6 }]
                    },
                    options: { scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }, responsive: true }
                });
                
                const occ = this.inventory.filter(i=>i.status==='occupied').length;
                const vac = this.inventory.length - occ;
                
                new Chart(document.getElementById('occChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Occupied', 'Vacant'],
                        datasets: [{ data: [occ, vac], backgroundColor: ['#008a05', '#f0f0f0'], borderWidth: 0 }]
                    },
                    options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } }
                });
            }, 100);
        }

        renderStaffView(container) {
            container.innerHTML = `
                <div class="dashboard-wrapper">
                    <h2 style="font-size:1.8rem; margin-bottom:20px;">Operations Portal</h2>
                    <div class="mgmt-tabs">
                        <div class="mgmt-tab ${this.activeStaffTab === 'ops' ? 'active' : ''}" onclick="app.setStaffTab('ops')"><i class="fa-solid fa-calendar-check"></i> Bookings</div>
                        <div class="mgmt-tab ${this.activeStaffTab === 'expenditure' ? 'active' : ''}" onclick="app.setStaffTab('expenditure')"><i class="fa-solid fa-money-bill-transfer"></i> Record Expense</div>
                        <div class="mgmt-tab ${this.activeStaffTab === 'refunds' ? 'active' : ''}" onclick="app.setStaffTab('refunds')"><i class="fa-solid fa-rotate-left"></i> Refunds</div>
                        <div class="mgmt-tab ${this.activeStaffTab === 'map' ? 'active' : ''}" onclick="app.setStaffTab('map')"><i class="fa-solid fa-map"></i> Map View</div>
                    </div>
                    
                    ${this.activeStaffTab === 'ops' ? `
                        <div class="search-container">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            <input type="text" placeholder="Search guests or units..." onkeyup="app.updateSearch(this.value)">
                        </div>
                        <div id="gridArea"></div>` 
                    : this.activeStaffTab === 'map' ? this.renderMapTab() 
                    : this.activeStaffTab === 'refunds' ? this.renderRefundTab() 
                    : this.renderExpenditureTab()}
                </div>`;
            if(this.activeStaffTab === 'ops') this.renderFilteredGrid(document.getElementById('gridArea'));
        }

        renderRefundTab() {
            return `
            <div class="panel">
                <h3><i class="fa-solid fa-hand-holding-dollar" style="color:var(--warning)"></i> Request Guest Refund</h3>
                <p style="font-size:0.9rem; color:var(--gray);">Refunds are automatically deducted from system revenue upon submission.</p>
                <div class="expense-form-grid">
                    <div class="input-group"><label>Guest Name</label><div class="input-wrapper"><i class="fa-regular fa-user"></i><input type="text" id="refGuest" class="styled-input"></div></div>
                    <div class="input-group"><label>Amount (₦)</label><div class="input-wrapper"><i class="fa-solid fa-naira-sign"></i><input type="number" id="refAmount" class="styled-input"></div></div>
                    <div class="input-group"><label>Date</label><div class="input-wrapper"><i class="fa-regular fa-calendar"></i><input type="date" id="refDate" class="styled-input" value="${new Date().toISOString().split('T')[0]}"></div></div>
                    <div class="input-group"><label>Reason</label><div class="input-wrapper"><i class="fa-regular fa-comment-dots"></i><input type="text" id="refReason" class="styled-input" placeholder="e.g. Early checkout"></div></div>
                </div>
                <div class="input-group" style="margin-top:20px; max-width:50%;"><label>Staff ID</label><div class="input-wrapper"><i class="fa-solid fa-id-badge"></i><input type="text" id="refStaffId" class="styled-input"></div></div>
                <button class="action-btn btn-save" style="margin-top:25px; background:var(--warning); color:black;" onclick="app.addRefund()"><i class="fa-solid fa-paper-plane"></i> Submit Refund Request</button>

                <h3 style="margin-top:50px;">Recent Refund Requests</h3>
                <div class="table-container">
                    <table class="expense-table">
                        <thead><tr><th>Date</th><th>Guest</th><th>Reason</th><th>Staff</th><th>Amount</th><th>Status</th></tr></thead>
                        <tbody>
                            ${this.refunds.slice().reverse().slice(0,10).map((r) => `
                                <tr>
                                    <td>${r.date}</td><td><strong>${r.guest}</strong></td><td>${r.reason}</td><td>${r.staffId}</td>
                                    <td>${this.formatCurrency(r.amount)}</td>
                                    <td><span style="padding:5px 10px; background:#fff3cd; color:#856404; border-radius:15px; font-size:0.75rem; font-weight:600;">Processed</span></td>
                                </tr>
                            `).join('')}
                            ${this.refunds.length === 0 ? '<tr><td colspan="6" style="text-align:center; padding:30px; color:#999;">No refunds recorded.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        renderMapTab() {
            return `
            <div class="panel">
                <h3><i class="fa-solid fa-location-dot" style="color:var(--primary)"></i> Property Locations</h3>
                <div id="staffMap" class="map-container" style="height:500px;"></div>
            </div>`;
        }

        renderExpenditureTab() {
            const locations = [...new Set(this.inventory.map(i => i.loc))];
            return `
                <div class="panel">
                    <h3><i class="fa-solid fa-file-invoice" style="color:var(--primary)"></i> Record New Sundry Expense</h3>
                    <div class="expense-form-grid">
                        <div class="input-group"><label>Amount (₦)</label><div class="input-wrapper"><i class="fa-solid fa-naira-sign"></i><input type="number" id="expAmt" class="styled-input"></div></div>
                        <div class="input-group"><label>Category</label>
                            <div class="input-wrapper"><i class="fa-solid fa-tag"></i>
                            <select id="expCat" class="styled-select">
                                <option value="Utilities">Utilities</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Toileteries">Toileteries</option>
                                <option value="Subscriptions">Subscriptions</option>
                                <option value="Logistics">Logistics</option>
                                <option value="Other">Other</option>
                            </select></div>
                        </div>
                        <div class="input-group"><label>Scope</label>
                            <div class="input-wrapper"><i class="fa-solid fa-building"></i>
                            <select id="expUnit" class="styled-select">
                                <option value="global">Global Ops</option>
                                ${locations.map(loc => `<option value="loc:${loc}">📍 All ${loc}</option>`).join('')}
                                ${this.inventory.map(u => `<option value="unit:${u.id}">🏠 ${u.name} (${u.loc})</option>`).join('')}
                            </select></div>
                        </div>
                        <div class="input-group"><label>Date</label><div class="input-wrapper"><i class="fa-regular fa-calendar"></i><input type="date" id="expDate" class="styled-input" value="${new Date().toISOString().split('T')[0]}"></div></div>
                    </div>
                    <div class="input-group" style="margin-top:15px;"><label>Details</label><div class="input-wrapper"><i class="fa-solid fa-pen"></i><input type="text" id="expDesc" class="styled-input" placeholder="Describe expense..."></div></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
                        <div class="input-group"><label>Staff ID</label><div class="input-wrapper"><i class="fa-solid fa-id-badge"></i><input type="text" id="expStaffId" class="styled-input"></div></div>
                        <div class="input-group"><label>Staff PIN</label><div class="input-wrapper"><i class="fa-solid fa-key"></i><input type="password" id="expStaffPin" class="styled-input"></div></div>
                    </div>
                    <button class="action-btn btn-save" style="margin-top:25px;" onclick="app.addExpenditure()"><i class="fa-solid fa-cloud-arrow-up"></i> Add Expense & Sync</button>
                    
                    <h3 style="margin-top:50px;">Recent Sundry Log</h3>
                    <div class="table-container">
                        <table class="expense-table">
                            <thead><tr><th>Date</th><th>Category</th><th>Scope</th><th>Staff</th><th>Amount</th><th>Action</th></tr></thead>
                            <tbody>
                                ${this.expenditures.slice().reverse().slice(0,10).map((e, idx) => `
                                    <tr><td>${e.date}</td><td>${e.category}</td><td>${e.unitId}</td><td>${e.staffId}</td><td>${this.formatCurrency(e.amount)}</td>
                                    <td><button onclick="app.deleteExpenditure(${this.expenditures.length - 1 - idx})" style="border:none; color:red; cursor:pointer; background:none;"><i class="fa-solid fa-trash-can"></i></button></td></tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }

        renderFilteredGrid(targetDiv) {
            let data = this.inventory;
            
            // Search Filtering
            if(this.searchQuery) {
                const q = this.searchQuery.toLowerCase();
                data = data.filter(i => 
                    i.name.toLowerCase().includes(q) || 
                    i.loc.toLowerCase().includes(q) || 
                    (i.guestName && i.guestName.toLowerCase().includes(q))
                );
            }
            
            const locations = [...new Set(data.map(i => i.loc))];
            
            targetDiv.innerHTML = ''; // Clear first
            
            if(locations.length === 0) {
                targetDiv.innerHTML = "<div style='padding:40px; text-align:center; color:#999; font-size:1.1rem;'><i class='fa-solid fa-magnifying-glass' style='font-size:2rem; margin-bottom:10px;'></i><br>No properties found matching your search.</div>";
                return;
            }

            locations.forEach(loc => {
                const section = document.createElement('div');
                section.className = 'location-section';
                section.innerHTML = `<div class="location-header"><div class="location-title"><i class="fa-solid fa-location-dot" style="color:var(--primary)"></i> ${loc}</div></div><div class="cards-grid"></div>`;
                const grid = section.querySelector('.cards-grid');
                data.filter(i => i.loc === loc).forEach(p => grid.appendChild(this.createCard(p)));
                targetDiv.appendChild(section);
            });
        }

        createCard(prop) {
            const isOcc = prop.status === 'occupied';
            const div = document.createElement('div');
            div.className = 'property-card';
            
            // Generate icon based on type
            let icon = '<i class="fa-solid fa-bed"></i>';
            if(prop.name.toLowerCase().includes('studio')) icon = '<i class="fa-solid fa-couch"></i>';
            if(prop.name.toLowerCase().includes('duplex')) icon = '<i class="fa-solid fa-layer-group"></i>';

            let btnHtml = isOcc 
                ? (this.role === 'staff' ? `<button class="action-btn btn-checkout" onclick="app.checkout('${prop.id}')"><i class="fa-solid fa-right-from-bracket"></i> Check Out</button>` : `<div style="text-align:center; padding:12px; color:var(--primary); font-weight:600;">Occupied</div>`) 
                : (this.role === 'staff' ? `<button class="action-btn btn-book" onclick="app.openBookingModal('single', '${prop.id}', '${prop.name}', ${prop.price})"><i class="fa-solid fa-calendar-plus"></i> Book Unit</button>` : `<div style="text-align:center; padding:12px; color:var(--success); font-weight:600;">Available</div>`);
            
            div.innerHTML = `
                <div class="status-badge ${isOcc ? 'status-booked' : 'status-avail'}">${isOcc ? 'Occupied' : 'Available'}</div>
                <div class="card-img-placeholder">${icon}</div>
                <div class="card-content">
                    <div class="prop-name">${prop.name}</div>
                    <div class="prop-loc"><i class="fa-solid fa-map-pin"></i> ${prop.loc}</div>
                    <div class="prop-price">${this.formatCurrency(prop.price)}<span>/night</span></div>
                    ${isOcc ? `
                    <div class="guest-info" style="margin-bottom:15px; background:#f9f9f9; padding:10px; border-radius:8px; font-size:0.9rem;">
                        <i class="fa-solid fa-user"></i> <strong>${prop.guestName}</strong><br>
                        ${prop.accessCode ? `<span style="color:var(--primary); font-weight:700; font-size:1.1rem; display:block; margin-top:5px; border-top:1px dashed #ddd; padding-top:5px;"><i class="fa-solid fa-key"></i> CODE: ${prop.accessCode}</span>` : ''}
                    </div>` : ''} 
                    ${btnHtml}
                </div>`;
            return div;
        }
        
        // --- LOGIC FUNCTIONS (Mostly unchanged but integrated with new UI) ---
        addExpenditure() {
            const amt = parseFloat(document.getElementById('expAmt').value);
            const sid = document.getElementById('expStaffId').value;
            const scope = document.getElementById('expUnit').value;
            if(!amt || !sid) {
                 this.showNotification("Please fill amount and Staff ID", "error");
                 return;
            }
            this.expenditures.push({
                amount: amt, date: document.getElementById('expDate').value,
                category: document.getElementById('expCat').value,
                unitId: scope, location: scope.includes('loc:') ? scope.split('loc:')[1] : 'global',
                description: document.getElementById('expDesc').value, staffId: sid
            });
            this.saveLocalData();
            this.showNotification("Expenditure recorded successfully", "success");
        }

        addRefund() {
            const guest = document.getElementById('refGuest').value;
            const amt = parseFloat(document.getElementById('refAmount').value);
            const reason = document.getElementById('refReason').value;
            const staff = document.getElementById('refStaffId').value;
            const date = document.getElementById('refDate').value;

            if(!guest || isNaN(amt) || !reason) {
                this.showNotification("Please fill all fields", "error");
                return;
            }

            this.refunds.push({
                date, guest, amount: amt, reason, staffId: staff
            });
            
            this.saveLocalData();
            this.showNotification("Refund request submitted successfully", "success");
            // Clear form
            document.getElementById('refGuest').value = '';
            document.getElementById('refAmount').value = '';
            document.getElementById('refReason').value = '';
        }

        requestRole(r) {
            if(r === 'staff') { this.setRole('staff'); return; }
            this.pendingRole = r;
            document.getElementById('pinModal').style.display = 'flex';
            setTimeout(() => document.getElementById('pinModal').classList.add('show'), 10);
            setTimeout(() => document.getElementById('rolePinInput').focus(), 50); 
        }

        verifyPin() {
            const p = document.getElementById('rolePinInput').value;
            if(p === this.rolePins[this.pendingRole]) { 
                this.setRole(this.pendingRole); 
                this.closeModal(); 
                this.showNotification(`Welcome, ${this.pendingRole.charAt(0).toUpperCase() + this.pendingRole.slice(1)}`, "success");
            } else { 
                this.showNotification("Incorrect Access PIN", "error");
                document.getElementById('rolePinInput').value = '';
            }
        }
        
        openTargetModal() {
             document.getElementById('targetModal').style.display = 'flex';
             setTimeout(() => document.getElementById('targetModal').classList.add('show'), 10);
        }
        
        saveTarget() {
            const loc = document.getElementById('targetLoc').value;
            const month = document.getElementById('targetMonth').value; 
            const val = parseFloat(document.getElementById('targetVal').value);
            
            if(loc && val && month) {
                const key = `${loc}_${month}`;
                this.targets[key] = val;
                this.saveLocalData();
                this.closeModal();
                this.showNotification(`Target for ${loc} (${month}) updated to ${this.formatCurrency(val)}`, "success");
            } else {
                this.showNotification("Please select location, month, and amount.", "error");
            }
        }

        setRole(r) { this.role = r; this.render(); }
        
        setStaffTab(t) { 
            this.activeStaffTab = t; 
            this.render(); 
            if(t === 'map') setTimeout(() => this.initMap('staffMap'), 500);
        }
        
        setMgmtTab(t) { this.activeMgmtTab = t; this.render(); }
        deleteExpenditure(idx) { this.expenditures.splice(idx,1); this.saveLocalData(); this.showNotification("Item deleted", "info"); }
        formatCurrency(n) { return "₦" + Math.round(n).toLocaleString(); }
        updateDate(t,v) { t==='from'?this.dateFrom=v:this.dateTo=v; this.render(); }
        updateMgmtFilter(v) { this.managementFilter = v; this.render(); }
        updateFilter(t, v) { this.filters[t] = v; this.render(); }
        updateSearch(v) { this.searchQuery = v; this.renderFilteredGrid(document.getElementById('gridArea')); }
        
        updateSyncUI(s) {
            const dot = document.getElementById('syncDot');
            if(dot) dot.className = `sync-dot ${s === 'online' ? 'online' : s === 'syncing' ? 'syncing' : 'offline'}`;
            const statusText = document.getElementById('syncStatus');
            if(statusText) statusText.innerText = s === 'online' ? 'Cloud Synced' : s === 'syncing' ? 'Syncing...' : 'Offline Mode';
        }
        
        closeModal() { document.querySelectorAll('.modal').forEach(m => { m.classList.remove('show'); setTimeout(()=>m.style.display='none',300); }); }

        openBookingModal(mode, id, name, price) {
            this.activeModalMode = mode;
            this.activeModalPropId = id;
            document.getElementById('modalPropName').innerText = name;
            document.getElementById('modalPropPrice').innerText = this.formatCurrency(price) + " / night";
            document.getElementById('bookingModal').style.display = 'flex';
            setTimeout(() => document.getElementById('bookingModal').classList.add('show'), 10);
            this.calcTotal();
        }

        calcTotal() {
            const d1 = new Date(document.getElementById('checkInDate').value);
            const d2 = new Date(document.getElementById('checkOutDate').value);
            const nights = Math.max(1, Math.ceil((d2 - d1) / 86400000));
            document.getElementById('nightCount').innerText = isNaN(nights) ? 1 : nights;
            const p = this.inventory.find(i => i.id === this.activeModalPropId);
            const total = (p ? p.price : 0) * (isNaN(nights) ? 1 : nights);
            document.getElementById('modalTotal').innerText = this.formatCurrency(total);
            document.getElementById('actualPaid').value = total;
        }

        // --- NEW SMART LOCK FUNCTION ---
        async generateLockCode(unitId, checkIn, checkOut) {
            const deviceId = this.LOCK_MAPPING[unitId];
            
            if (!deviceId || deviceId.includes('REPLACE')) {
                console.warn("No Lock ID mapped for this unit");
                return "MANUAL-KEY"; 
            }

            try {
                const response = await fetch(this.googleScriptUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'generateCode',
                        deviceId: deviceId,
                        checkIn: checkIn,
                        checkOut: checkOut
                    })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    return data.accessCode;
                } else {
                    return "OFFLINE";
                }
            } catch (e) {
                return "OFFLINE";
            }
        }

        async confirmBooking() {
            const p = this.inventory.find(i => i.id === this.activeModalPropId);
            const paid = parseFloat(document.getElementById('actualPaid').value);
            const guest = document.getElementById('guestName').value;
            const checkIn = document.getElementById('checkInDate').value;
            const checkOut = document.getElementById('checkOutDate').value;

            if(!p || !guest || !paid || !checkIn || !checkOut) {
                 this.showNotification("Please complete all booking details", "error");
                 return;
            }

            // UI Feedback
            const btn = document.getElementById('btnConfirm');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="spinner"></div> Connecting...`;
            btn.disabled = true;

            // 1. Generate Smart Lock Code
            const doorCode = await this.generateLockCode(p.id, checkIn, checkOut);

            // 2. Update Inventory Object
            p.status = 'occupied';
            p.guestName = guest;
            p.accessCode = doorCode; 

            // 3. Save to Transaction Log
            this.transactions.push({ 
                date: new Date().toISOString().split('T')[0], 
                propId: p.id, 
                amount: paid, 
                guest: guest,
                accessCode: doorCode 
            });

            this.saveLocalData();
            this.closeModal();
            
            // 4. Alert the Staff
            alert(`✅ Booking Confirmed for ${guest}!\n\n🔐 ACCESS CODE: ${doorCode}\n\nPlease share this code with the guest.`);
            this.showNotification("Booking confirmed & Code Generated!", "success");
            
            // Reset Button
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        checkout(id) {
            const p = this.inventory.find(i => i.id === id);
            p.status = 'available';
            p.guestName = null;
            p.accessCode = null; // Clear code on checkout
            this.saveLocalData();
            this.showNotification("Guest checked out", "info");
        }

        initMap(elementId) {
            if (!document.getElementById(elementId)) return;
            if (this.maps && this.maps[elementId]) { this.maps[elementId].remove(); }
            
            const map = L.map(elementId).setView([9.11648, 7.4037915], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

            const redIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            const locs = [
                { name: "The White House", lat: 9.106198, lng: 7.377890 },
                { name: "Hilltop", lat: 9.129424, lng: 7.429680 },
                { name: "Jahi", lat: 9.103536, lng: 7.425503 }
            ];

            locs.forEach(l => {
                L.marker([l.lat, l.lng], {icon: redIcon}).addTo(map)
                    .bindPopup(`<b>${l.name}</b><br>Amada Luxury Stays`)
                    .openPopup();
            });
            
            if(!this.maps) this.maps = {};
            this.maps[elementId] = map;
        }
    }
    const app = new AmadaApp();
</script>
</body>
</html>
