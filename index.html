<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amada Luxury Stays | Management Portal</title>
    <!-- Elegant Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet Map CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            --primary: #FF385C; 
            --primary-hover: #d9304e;
            --dark: #222222;
            --gray: #717171;
            --light: #F7F7F7;
            --white: #FFFFFF;
            --success: #008a05;
            --warning: #faad14;
            --danger: #dc3545;
            --blue: #0066cc;
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
            --shadow-hover: 0 15px 35px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background: var(--bg-gradient);
            color: var(--dark);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 80px; 
        }

        /* --- Header & Nav --- */
        header {
            background: var(--glass);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 15px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .role-toggle {
            background: #eee;
            border-radius: 30px;
            padding: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .role-btn {
            border: none;
            background: transparent;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            color: var(--gray);
        }

        .role-btn.active {
            background: var(--white);
            color: var(--dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: scale(1.02);
        }
        
        .sync-indicator {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--gray);
            font-weight: 500;
        }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .sync-dot.online { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .sync-dot.syncing { background: var(--warning); animation: pulse-yellow 1s infinite; }

        @keyframes pulse-yellow { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* --- Main Layout --- */
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .dashboard-wrapper { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- KPI Cards --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--white);
            padding: 25px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
        .kpi-card.highlight { border-left: 4px solid var(--primary); }
        .kpi-card.success { border-left: 4px solid var(--success); }
        .kpi-card.warning { border-left: 4px solid var(--warning); }

        .kpi-title { font-size: 0.85rem; color: var(--gray); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .kpi-value { font-size: 1.8rem; font-weight: 600; color: var(--dark); }
        .kpi-sub { font-size: 0.8rem; color: var(--gray); margin-top: 5px; }

        /* --- Accounting / Management Styles --- */
        .accounts-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; }
        .expense-panel { background: var(--white); padding: 30px; border-radius: 20px; box-shadow: var(--shadow); }
        .expense-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .expense-input-group label { display: block; font-size: 0.85rem; color: var(--gray); margin-bottom: 8px; font-weight: 500; }
        .expense-input-group input, .expense-input-group select {
            width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px; font-family: 'Poppins'; font-size: 1rem;
            transition: 0.3s; background: #fafafa;
        }

        .profit-summary {
            background: var(--dark); color: white; padding: 30px; border-radius: 20px; box-shadow: var(--shadow);
            display: flex; flex-direction: column; justify-content: center;
        }
        .profit-row { display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .profit-label { font-size: 0.9rem; opacity: 0.8; }
        .profit-val { font-size: 1.05rem; font-weight: 500; }
        .net-profit { font-size: 2.2rem; font-weight: 600; color: var(--success); text-shadow: 0 2px 10px rgba(0,255,0,0.2); }
        .net-loss { color: var(--primary); }

        /* --- Controls Bar --- */
        .controls-bar {
            background: var(--white); padding: 15px 25px; border-radius: 12px; display: flex;
            gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 30px; box-shadow: var(--shadow);
        }
        .control-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 150px; }
        .control-label { font-size: 0.75rem; font-weight: 600; color: var(--gray); text-transform: uppercase; }
        
        .custom-select, .date-input {
            width: 100%; padding: 10px 12px; border: 1px solid #eee; border-radius: 8px;
            font-family: 'Poppins'; font-size: 0.9rem; background: #fcfcfc; cursor: pointer;
        }

        /* --- Tabs --- */
        .mgmt-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .mgmt-tab { 
            padding: 10px 20px; border-radius: 10px; background: #eee; cursor: pointer; 
            font-weight: 500; font-size: 0.9rem; transition: 0.2s;
        }
        .mgmt-tab.active { background: var(--dark); color: white; }

        /* --- Expense Table --- */
        .expense-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        .expense-table th { text-align: left; padding: 10px; background: #f9f9f9; color: var(--gray); font-weight: 600; }
        .expense-table td { padding: 10px; border-bottom: 1px solid #eee; }

        /* --- Property Sections --- */
        .location-section { margin-bottom: 50px; }
        .location-header {
            display: flex; justify-content: space-between; align-items: end; margin-bottom: 20px;
            padding-bottom: 10px; border-bottom: 2px solid #eee; flex-wrap: wrap; gap: 10px;
        }
        .location-title { font-size: 1.5rem; font-weight: 600; color: var(--dark); }

        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .property-card {
            background: var(--white); border-radius: 16px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); transition: all 0.3s ease; 
            position: relative; border: 1px solid rgba(0,0,0,0.02); display: flex; flex-direction: column;
        }
        .property-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-5px); }
        .status-stripe { height: 6px; width: 100%; }
        .status-avail { background: var(--success); }
        .status-booked { background: var(--primary); }

        .card-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .prop-name { font-weight: 600; font-size: 1.05rem; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .prop-price { font-size: 1.1rem; color: var(--dark); font-weight: 500; }

        .action-btn {
            width: 100%; padding: 12px; margin-top: auto; border: none; border-radius: 10px;
            font-weight: 600; font-family: 'Poppins', sans-serif; cursor: pointer; transition: 0.2s;
            text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px;
        }

        .btn-book { background: var(--dark); color: white; margin-top: 15px; }
        .btn-checkout { background: white; border: 1px solid #ddd; color: var(--dark); margin-top: 15px; }
        .btn-save { background: var(--success); color: white; font-size: 1rem; margin-top: 20px; width: 100%; padding: 15px; border-radius: 12px;}

        /* --- Modal --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.3s;
        }
        .modal.show { opacity: 1; }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px; width: 95%; max-width: 500px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s;
            max-height: 90vh; overflow-y: auto;
        }
        .modal.show .modal-content { transform: scale(1); }

        .total-display { background: #f7f7f7; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 1px dashed #ddd; }
        .total-amount { font-size: 1.8rem; font-weight: 600; color: var(--primary); }

        /* Map Container */
        .map-container {
            width: 100%; height: 500px; border-radius: 15px; overflow: hidden; margin-top: 20px;
            box-shadow: var(--shadow); border: 1px solid #eee; z-index: 1;
        }
    </style>
</head>
<body>

<header>
    <div class="nav-container">
        <div class="brand">Amada <span style="font-weight:300">Stays</span></div>
        <div class="role-toggle">
            <button id="btnStaff" class="role-btn active" onclick="app.requestRole('staff')">Staff</button>
            <button id="btnMgmt" class="role-btn" onclick="app.requestRole('management')">Management</button>
            <button id="btnChair" class="role-btn" onclick="app.requestRole('chairman')">Chairman</button>
        </div>
        <div class="sync-indicator">
            <div id="syncDot" class="sync-dot"></div>
            <span id="syncStatus">Cloud Idle</span>
        </div>
    </div>
</header>

<div class="container" id="appContainer"></div>

<!-- PIN MODAL -->
<div id="pinModal" class="modal">
    <div class="modal-content" style="max-width:350px; text-align:center;">
        <h3 id="pinTitle" style="margin-top:0">Access Required</h3>
        <p style="font-size:0.85rem; color:var(--gray);">Enter PIN to view restricted area</p>
        <div class="form-group">
            <input type="password" id="rolePinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align:center; font-size:1.5rem; letter-spacing:10px; width:100%; padding:12px; border:1px solid #ddd; border-radius:10px;">
        </div>
        <div class="modal-actions" style="display:flex; gap:10px; margin-top:20px;">
            <button class="action-btn" style="background:#eee; flex:1;" onclick="app.closeModal()">Cancel</button>
            <button class="action-btn" style="background:var(--dark); color:white; flex:1;" onclick="app.verifyPin()">Enter</button>
        </div>
    </div>
</div>

<!-- TARGET MODAL -->
<div id="targetModal" class="modal">
    <div class="modal-content" style="max-width:400px;">
        <h3 style="margin-top:0">Set Monthly Target</h3>
        <div class="form-group">
            <label>Select Location</label>
            <select id="targetLoc" class="custom-select">
                <option value="Hilltop">Hilltop</option>
                <option value="Jahi">Jahi</option>
                <option value="The White House">The White House</option>
            </select>
        </div>
        <div class="form-group">
            <label>Select Month</label>
            <input type="month" id="targetMonth" class="date-input">
        </div>
        <div class="form-group">
            <label>Target Amount (‚Ç¶)</label>
            <input type="number" id="targetVal" class="date-input" placeholder="e.g. 15000000">
        </div>
        <button class="action-btn btn-save" onclick="app.saveTarget()">Save Target</button>
        <button class="action-btn" style="background:none; color:var(--gray); margin-top:10px;" onclick="app.closeModal()">Cancel</button>
    </div>
</div>

<!-- BOOKING MODAL -->
<div id="bookingModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0">Booking Details</h3>
        <div id="modalPropList" style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:15px;"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div class="form-group"><label>Check-In</label><input type="date" id="checkInDate" onchange="app.calcTotal()" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></div>
            <div class="form-group"><label>Check-Out</label><input type="date" id="checkOutDate" onchange="app.calcTotal()" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></div>
        </div>
        <div class="form-group"><label>Guest Name</label><input type="text" id="guestName" placeholder="e.g. Mr. John" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></div>
        <div class="total-display">
            <div class="total-label" style="font-size: 0.8rem; color: var(--gray); text-transform: uppercase;">Estimated Total (<span id="nightCount">1</span> Nights)</div>
            <div class="total-amount" id="modalTotal">‚Ç¶0</div>
        </div>
        <div class="form-group"><label>Actual Amount Paid</label><input type="number" id="actualPaid" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></div>
        <button class="action-btn btn-save" onclick="app.confirmBooking()">Confirm & Sync</button>
        <button class="action-btn" style="background:none; color:var(--gray); width:100%; margin-top:10px;" onclick="app.closeModal()">Cancel</button>
    </div>
</div>

<script>
    class AmadaApp {
        constructor() {
            this.role = 'staff';
            this.pendingRole = null;
            this.activeMgmtTab = 'pl'; 
            this.activeStaffTab = 'ops'; 
            this.googleScriptUrl = "https://script.google.com/macros/s/AKfycbwfVJe5Kor2NYeiUz-mjj7zXDeBovXmclxLZ5U8WC5gust_Ad2s6fOxmOARyZV1ajQ4Sg/exec";
            
            this.rolePins = { 'management': '4444', 'chairman': '8888' };
            this.filters = { location: 'all', status: 'all' };
            this.managementFilter = 'all'; 
            this.sortBy = 'default';

            const today = new Date();
            this.dateFrom = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            this.dateTo = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0]; 

            this.reportBaselines = {
                'Hilltop': { salary: 694000, sundry: 749000 },
                'Jahi': { salary: 675000, sundry: 1096000 },
                'The White House': { salary: 522000, sundry: 453070 }
            };

            this.targets = {}; 
            this.inventory = this.getInitialInventory();
            this.transactions = []; 
            this.expenditures = []; 
            this.refunds = [];

            this.init();
        }

        async init() {
            this.loadLocalData();
            this.render();
            this.setupPinEnter();
            await this.syncFromCloud();
        }

        setupPinEnter() {
            const pinInput = document.getElementById('rolePinInput');
            if (pinInput) {
                pinInput.addEventListener("keypress", (event) => {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        this.verifyPin();
                    }
                });
            }
        }

        getInitialInventory() {
            let inv = [
                { id: 'k1', loc: 'Hilltop', name: '4 Bed Duplex 1', price: 250000, status: 'available' },
                { id: 'k2', loc: 'Hilltop', name: '4 Bed Duplex 2', price: 250000, status: 'available' },
                { id: 'k3', loc: 'Hilltop', name: '1 Bed Apt A', price: 80000, status: 'available' },
                { id: 'j1', loc: 'Jahi', name: '2 Bed Apt (A)', price: 120000, status: 'available' },
                { id: 'j2', loc: 'Jahi', name: '1 Bed Apt (B)', price: 70000, status: 'available' },
                { id: 'j3', loc: 'Jahi', name: 'Studio (X)', price: 50000, status: 'available' },
                { id: 'g1', loc: 'The White House', name: 'Studio Unit 1', price: 40000, status: 'available' },
                { id: 'g2', loc: 'The White House', name: '1 Bed Unit A', price: 50000, status: 'available' }
            ];
            return inv;
        }

        loadLocalData() {
            const keys = ['amadaInventory', 'amadaTransactions', 'amadaExpenditures', 'amadaTargets', 'amadaRefunds'];
            keys.forEach(k => {
                const val = localStorage.getItem(k);
                if(val) this[k.replace('amada', '').toLowerCase()] = JSON.parse(val);
            });
        }

        saveLocalData() {
            localStorage.setItem('amadaInventory', JSON.stringify(this.inventory));
            localStorage.setItem('amadaTransactions', JSON.stringify(this.transactions));
            localStorage.setItem('amadaExpenditures', JSON.stringify(this.expenditures));
            localStorage.setItem('amadaTargets', JSON.stringify(this.targets));
            localStorage.setItem('amadaRefunds', JSON.stringify(this.refunds));
            this.render();
            this.syncToCloud(); 
        }

        async syncFromCloud() {
            this.updateSyncUI('syncing');
            try {
                const res = await fetch(this.googleScriptUrl);
                const data = await res.json();
                if (data.inventory?.length > 0) this.inventory = data.inventory;
                if (data.transactions) this.transactions = data.transactions;
                if (data.expenditures) this.expenditures = data.expenditures;
                if (data.targets) this.targets = data.targets;
                if (data.refunds) this.refunds = data.refunds;
                this.saveLocalData(); 
                this.updateSyncUI('online');
            } catch (e) { this.updateSyncUI('offline'); }
        }

        async syncToCloud() {
            this.updateSyncUI('syncing');
            const payload = { 
                inventory: this.inventory, 
                transactions: this.transactions, 
                expenditures: this.expenditures, 
                targets: this.targets,
                refunds: this.refunds
            };
            try {
                const res = await fetch(this.googleScriptUrl, { method: 'POST', body: JSON.stringify(payload) });
                if ((await res.json()).status === 'success') this.updateSyncUI('online');
            } catch (e) { this.updateSyncUI('offline'); }
        }

        render() {
            const container = document.getElementById('appContainer');
            container.innerHTML = '';
            if (this.role === 'chairman') this.renderChairmanDashboard(container);
            else if (this.role === 'management') this.renderManagementView(container);
            else this.renderStaffView(container);
            
            this.setupPinEnter();
        }

        renderManagementView(container) {
            let scopeProps = [...this.inventory];
            let targetLocs = Object.keys(this.reportBaselines);

            if (this.managementFilter.startsWith('loc:')) {
                const loc = this.managementFilter.split('loc:')[1];
                scopeProps = this.inventory.filter(i => i.loc === loc);
                targetLocs = [loc];
            } else if (this.managementFilter.startsWith('unit:')) {
                const unitId = this.managementFilter.split('unit:')[1];
                const unit = this.inventory.find(i => i.id === unitId);
                scopeProps = unit ? [unit] : [];
                targetLocs = unit ? [unit.loc] : [];
            }

            const d1 = new Date(this.dateFrom);
            const d2 = new Date(this.dateTo);
            const daysDiff = Math.max(1, (d2 - d1) / 86400000);
            const factor = daysDiff / 30; 

            // Revenue Calculation
            const grossRevenue = this.transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= d1 && tDate <= d2 && scopeProps.some(p => p.id === t.propId);
            }).reduce((s, t) => s + (t.amount || 0), 0);

            // Refund Calculation
            const totalRefunds = this.refunds.filter(r => {
                const rDate = new Date(r.date);
                return rDate >= d1 && rDate <= d2;
            }).reduce((s, r) => s + parseFloat(r.amount), 0);

            const netRevenue = grossRevenue - totalRefunds;

            const tax = netRevenue * 0.125;
            const maintenance = netRevenue * 0.05; 
            const rentExpense = scopeProps.reduce((s, p) => s + (1500000/365 * daysDiff), 0);
            
            let baselineSalary = 0;
            let baselineSundry = 0;

            targetLocs.forEach(l => {
                if(this.reportBaselines[l]) {
                    const subRatio = this.managementFilter.startsWith('unit:') ? (1 / this.inventory.filter(i => i.loc === l).length) : 1;
                    baselineSalary += this.reportBaselines[l].salary * factor * subRatio;
                    baselineSundry += this.reportBaselines[l].sundry * factor * subRatio;
                }
            });

            const additionalExp = this.expenditures.filter(e => {
                const eDate = new Date(e.date);
                const scopeMatch = this.managementFilter === 'all' || (this.managementFilter.startsWith('loc:') && e.location === this.managementFilter.split('loc:')[1]) || (this.managementFilter.startsWith('unit:') && e.unitId === this.managementFilter.split('unit:')[1]);
                return eDate >= d1 && eDate <= d2 && scopeMatch;
            }).reduce((s, e) => s + parseFloat(e.amount), 0);

            const totalSundryActual = baselineSundry + additionalExp;
            const netProfit = netRevenue - tax - maintenance - rentExpense - baselineSalary - totalSundryActual;

            let dropdownHtml = `<option value="all">All Locations (Consolidated)</option>`;
            Object.keys(this.reportBaselines).forEach(loc => {
                dropdownHtml += `<optgroup label="${loc}">`;
                dropdownHtml += `<option value="loc:${loc}" ${this.managementFilter === `loc:${loc}` ? 'selected' : ''}>View ${loc} Total</option>`;
                this.inventory.filter(u => u.loc === loc).forEach(u => {
                    dropdownHtml += `<option value="unit:${u.id}" ${this.managementFilter === `unit:${u.id}` ? 'selected' : ''}>-- ${u.name}</option>`;
                });
                dropdownHtml += `</optgroup>`;
            });

            container.innerHTML = `
                <div class="dashboard-wrapper">
                    <div style="background:white; padding:25px; border-radius:15px; box-shadow:var(--shadow); margin-bottom:20px; display:flex; gap:20px; flex-wrap:wrap; align-items:end;">
                        <div style="flex:1; min-width:250px;">
                            <h2 style="margin:0">Management Hub</h2>
                            <p style="margin:5px 0 0; font-size:0.85rem; color:var(--gray);">Financial Report Data Integrated</p>
                        </div>
                        <div class="control-group"><label class="control-label">Period Start</label><input type="date" class="date-input" value="${this.dateFrom}" onchange="app.updateDate('from', this.value)"></div>
                        <div class="control-group"><label class="control-label">Period End</label><input type="date" class="date-input" value="${this.dateTo}" onchange="app.updateDate('to', this.value)"></div>
                        <div class="control-group"><label class="control-label">View Scope</label>
                            <select class="custom-select" onchange="app.updateMgmtFilter(this.value)">${dropdownHtml}</select>
                        </div>
                    </div>
                    
                    <div class="mgmt-tabs">
                        <div class="mgmt-tab ${this.activeMgmtTab === 'pl' ? 'active' : ''}" onclick="app.setMgmtTab('pl')">P&L Account</div>
                        <div class="mgmt-tab ${this.activeMgmtTab === 'expenditure' ? 'active' : ''}" onclick="app.setMgmtTab('expenditure')">Operations Recording</div>
                    </div>

                    ${this.activeMgmtTab === 'pl' ? `
                    <div class="accounts-grid">
                        <div class="expense-panel">
                            <h3>Monthly Baseline Details</h3>
                            <div style="margin-top:20px;">
                                <div class="profit-row"><span>Report Salaries</span><span>${this.formatCurrency(baselineSalary)}</span></div>
                                <div class="profit-row"><span>Report Sundry</span><span>${this.formatCurrency(baselineSundry)}</span></div>
                                <div class="profit-row"><span>Rent (Amortized)</span><span>${this.formatCurrency(rentExpense)}</span></div>
                            </div>
                        </div>
                        <div class="profit-summary">
                            <div style="font-size:1.1rem; font-weight:600; margin-bottom:20px; opacity:0.9;">Profit & Loss Statement</div>
                            <div class="profit-row"><span>Gross Revenue</span><span>${this.formatCurrency(grossRevenue)}</span></div>
                            <div class="profit-row"><span>Less: Refunds</span><span style="color:#ff6b6b">-${this.formatCurrency(totalRefunds)}</span></div>
                            <div class="profit-row" style="border-top:1px dashed rgba(255,255,255,0.2); padding-top:5px; margin-bottom:15px;">
                                <span>Net Revenue</span><span style="font-weight:600">${this.formatCurrency(netRevenue)}</span>
                            </div>
                            <div class="profit-row"><span>Less: VAT (12.5%)</span><span style="color:#ff6b6b">-${this.formatCurrency(tax)}</span></div>
                            <div class="profit-row"><span>Less: Maint (5%)</span><span style="color:#ff6b6b">-${this.formatCurrency(maintenance)}</span></div>
                            <div class="profit-row"><span>Less: Rent</span><span style="color:#ff6b6b">-${this.formatCurrency(rentExpense)}</span></div>
                            <div class="profit-row"><span>Less: Total Sundry</span><span style="color:#ff6b6b">-${this.formatCurrency(totalSundryActual)}</span></div>
                            <div class="profit-row"><span>Less: Salaries</span><span style="color:#ff6b6b">-${this.formatCurrency(baselineSalary)}</span></div>
                            <div style="margin-top:30px; border-top:2px solid rgba(255,255,255,0.2); padding-top:15px;">
                                <div class="profit-label">Net Profit / Loss</div>
                                <div class="${netProfit >= 0 ? 'net-profit' : 'net-profit net-loss'}">${this.formatCurrency(netProfit)}</div>
                            </div>
                        </div>
                    </div>` : this.renderExpenditureTab()}
                </div>`;
        }

        renderChairmanDashboard(container) {
            let data = [...this.inventory];
            if (this.filters.location !== 'all') data = data.filter(i => i.loc === this.filters.location);
            if (this.sortBy === 'price_high') data.sort((a,b) => b.price - a.price);
            else if (this.sortBy === 'price_low') data.sort((a,b) => a.price - b.price);

            const grossRev = this.transactions.filter(t => {
                const tDate = new Date(t.date);
                const d1 = new Date(this.dateFrom);
                const d2 = new Date(this.dateTo);
                const prop = this.inventory.find(p => p.id === t.propId);
                const locMatch = this.filters.location === 'all' || (prop && prop.loc === this.filters.location);
                return tDate >= d1 && tDate <= d2 && locMatch;
            }).reduce((s, t) => s + (t.amount || 0), 0);

            // Subtract Refunds for accurate Chair view
            const refunds = this.refunds.filter(r => {
                const rDate = new Date(r.date);
                return rDate >= new Date(this.dateFrom) && rDate <= new Date(this.dateTo);
            }).reduce((s, r) => s + parseFloat(r.amount), 0);

            const netRev = grossRev - refunds;

            // Get target for selected month (simplified to checking first month in range)
            const rangeMonth = this.dateFrom.substring(0, 7); // "YYYY-MM"
            let totalTarget = 0;
            const locs = [...new Set(this.inventory.map(i => i.loc))];
            
            locs.forEach(l => {
                if(this.filters.location === 'all' || this.filters.location === l) {
                    const key = `${l}_${rangeMonth}`;
                    totalTarget += (this.targets[key] || 0);
                }
            });

            const occCount = data.filter(i => i.status === 'occupied').length;
            const occupancyRate = data.length ? Math.round((occCount / data.length) * 100) : 0;
            
            container.innerHTML = `
                <div class="dashboard-wrapper">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2>Chairman's Dashboard</h2>
                        <button class="action-btn" style="width:auto; padding:10px 20px; background:var(--dark); color:white;" onclick="app.openTargetModal()">Set Monthly Targets</button>
                    </div>
                    
                    <div class="controls-bar" style="margin-top:20px;">
                         <div class="control-group"><label class="control-label">From</label><input type="date" class="date-input" value="${this.dateFrom}" onchange="app.updateDate('from', this.value)"></div>
                        <div class="control-group"><label class="control-label">To</label><input type="date" class="date-input" value="${this.dateTo}" onchange="app.updateDate('to', this.value)"></div>
                        <div class="control-group"><label class="control-label">Filter Location</label>
                            <select class="custom-select" onchange="app.updateFilter('location', this.value)">
                                <option value="all">All Locations</option>
                                ${locs.map(l => `<option value="${l}" ${this.filters.location === l ? 'selected' : ''}>${l}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="kpi-grid">
                        <div class="kpi-card highlight"><div class="kpi-title">Net Revenue</div><div class="kpi-value">${this.formatCurrency(netRev)}</div><div class="kpi-sub">Target: ${this.formatCurrency(totalTarget)}</div></div>
                        <div class="kpi-card success"><div class="kpi-title">Active Units</div><div class="kpi-value">${data.length}</div></div>
                        <div class="kpi-card warning"><div class="kpi-title">Occupancy</div><div class="kpi-value">${occupancyRate}%</div></div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; margin-bottom:30px;">
                        <div style="background:white; padding:20px; border-radius:15px; box-shadow:var(--shadow);">
                            <canvas id="revChart"></canvas>
                        </div>
                        <div style="background:white; padding:20px; border-radius:15px; box-shadow:var(--shadow);">
                            <canvas id="occChart"></canvas>
                        </div>
                    </div>

                    <h3>Property Map Overview</h3>
                    <div id="chairMap" class="map-container"></div>
                </div>`;
            
            this.renderCharts();
            setTimeout(() => this.initMap('chairMap'), 500);
        }

        renderCharts() {
            setTimeout(() => {
                const labels = Object.keys(this.reportBaselines);
                const dataRev = labels.map(l => {
                   return this.transactions.filter(t => {
                        const p = this.inventory.find(inv => inv.id === t.propId);
                        return p && p.loc === l;
                   }).reduce((s,t)=>s+(t.amount||0),0);
                });

                new Chart(document.getElementById('revChart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{ label: 'Gross Revenue (‚Ç¶)', data: dataRev, backgroundColor: '#FF385C' }]
                    }
                });
                
                const occ = this.inventory.filter(i=>i.status==='occupied').length;
                const vac = this.inventory.length - occ;
                
                new Chart(document.getElementById('occChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Occupied', 'Vacant'],
                        datasets: [{ data: [occ, vac], backgroundColor: ['#008a05', '#eee'] }]
                    }
                });
            }, 100);
        }

        renderStaffView(container) {
            container.innerHTML = `
                <div class="dashboard-wrapper">
                    <h2>Operations Portal</h2>
                    <div class="mgmt-tabs">
                        <div class="mgmt-tab ${this.activeStaffTab === 'ops' ? 'active' : ''}" onclick="app.setStaffTab('ops')">Bookings</div>
                        <div class="mgmt-tab ${this.activeStaffTab === 'expenditure' ? 'active' : ''}" onclick="app.setStaffTab('expenditure')">Record Sundry Expense</div>
                        <div class="mgmt-tab ${this.activeStaffTab === 'refunds' ? 'active' : ''}" onclick="app.setStaffTab('refunds')">Refund Requests</div>
                        <div class="mgmt-tab ${this.activeStaffTab === 'map' ? 'active' : ''}" onclick="app.setStaffTab('map')">Map View</div>
                    </div>
                    ${this.activeStaffTab === 'ops' ? '<div id="gridArea"></div>' : 
                      this.activeStaffTab === 'map' ? this.renderMapTab() : 
                      this.activeStaffTab === 'refunds' ? this.renderRefundTab() :
                      this.renderExpenditureTab()}
                </div>`;
            if(this.activeStaffTab === 'ops') this.renderFilteredGrid(document.getElementById('gridArea'), this.inventory);
        }

        renderRefundTab() {
            return `
            <div class="expense-panel">
                <h3>Request Guest Refund</h3>
                <p style="font-size:0.85rem; color:var(--gray);">Refunds are automatically deducted from system revenue upon submission.</p>
                <div class="expense-form-grid">
                    <div class="expense-input-group"><label>Guest Name</label><input type="text" id="refGuest"></div>
                    <div class="expense-input-group"><label>Amount (‚Ç¶)</label><input type="number" id="refAmount"></div>
                    <div class="expense-input-group"><label>Date</label><input type="date" id="refDate" value="${new Date().toISOString().split('T')[0]}"></div>
                </div>
                <div class="expense-input-group" style="margin-top:15px;"><label>Reason for Refund</label><input type="text" id="refReason" placeholder="e.g. Early checkout due to emergency"></div>
                <div style="margin-top:20px;">
                    <div class="expense-input-group"><label>Staff ID</label><input type="text" id="refStaffId"></div>
                </div>
                <button class="action-btn btn-save" style="margin-top:20px; background:var(--warning);" onclick="app.addRefund()">Submit Refund Request</button>

                <h3 style="margin-top:40px;">Recent Refund Requests</h3>
                <div style="overflow-x:auto">
                    <table class="expense-table">
                        <thead><tr><th>Date</th><th>Guest</th><th>Reason</th><th>Staff</th><th>Amount</th><th>Status</th></tr></thead>
                        <tbody>
                            ${this.refunds.slice().reverse().slice(0,10).map((r) => `
                                <tr>
                                    <td>${r.date}</td><td>${r.guest}</td><td>${r.reason}</td><td>${r.staffId}</td>
                                    <td>${this.formatCurrency(r.amount)}</td>
                                    <td><span style="padding:4px 8px; background:#fff3cd; color:#856404; border-radius:4px; font-size:0.75rem;">Processed</span></td>
                                </tr>
                            `).join('')}
                            ${this.refunds.length === 0 ? '<tr><td colspan="6" style="text-align:center; padding:15px; color:#999;">No refunds recorded.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        renderMapTab() {
            return `
            <div class="expense-panel">
                <h3>Property Locations</h3>
                <div id="staffMap" class="map-container" style="height:500px;"></div>
            </div>`;
        }

        initMap(elementId) {
            if (!document.getElementById(elementId)) return;
            // Clean up existing map instance if any (simple check)
            if (this.maps && this.maps[elementId]) {
                 this.maps[elementId].remove();
            }
            
            const map = L.map(elementId).setView([9.11648, 7.4037915], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            const redIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            const locs = [
                { name: "The White House", lat: 9.106198, lng: 7.377890 },
                { name: "Hilltop", lat: 9.129424, lng: 7.429680 },
                { name: "Jahi", lat: 9.103536, lng: 7.425503 }
            ];

            locs.forEach(l => {
                L.marker([l.lat, l.lng], {icon: redIcon}).addTo(map)
                    .bindPopup(`<b>${l.name}</b><br>Amada Luxury Stays`)
                    .openPopup();
            });
            
            // Store map ref
            if(!this.maps) this.maps = {};
            this.maps[elementId] = map;
        }

        renderExpenditureTab() {
            const locations = [...new Set(this.inventory.map(i => i.loc))];
            return `
                <div class="expense-panel">
                    <h3>Record New Sundry Expense</h3>
                    <div class="expense-form-grid">
                        <div class="expense-input-group"><label>Amount (‚Ç¶)</label><input type="number" id="expAmt"></div>
                        <div class="expense-input-group"><label>Category</label>
                            <select id="expCat">
                                <option value="Utilities">Utilities</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Toileteries">Toileteries</option>
                                <option value="Subscriptions">Subscriptions</option>
                                <option value="Logistics">Logistics</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="expense-input-group"><label>Scope</label>
                            <select id="expUnit">
                                <option value="global">Global Ops</option>
                                ${locations.map(loc => `<option value="loc:${loc}">üìç All ${loc}</option>`).join('')}
                                ${this.inventory.map(u => `<option value="unit:${u.id}">üè† ${u.name} (${u.loc})</option>`).join('')}
                            </select>
                        </div>
                        <div class="expense-input-group"><label>Date</label><input type="date" id="expDate" value="${new Date().toISOString().split('T')[0]}"></div>
                    </div>
                    <div class="expense-input-group" style="margin-top:15px;"><label>Details</label><input type="text" id="expDesc" placeholder="Describe..."></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
                        <div class="expense-input-group"><label>Staff ID</label><input type="text" id="expStaffId"></div>
                        <div class="expense-input-group"><label>Staff PIN</label><input type="password" id="expStaffPin"></div>
                    </div>
                    <button class="action-btn btn-save" style="margin-top:20px;" onclick="app.addExpenditure()">Add Expense & Sync</button>
                    
                    <h3 style="margin-top:40px;">Recent Sundry Log</h3>
                    <div style="overflow-x:auto">
                        <table class="expense-table">
                            <thead><tr><th>Date</th><th>Category</th><th>Scope</th><th>Staff</th><th>Amount</th><th>Action</th></tr></thead>
                            <tbody>
                                ${this.expenditures.slice().reverse().slice(0,10).map((e, idx) => `
                                    <tr><td>${e.date}</td><td>${e.category}</td><td>${e.unitId}</td><td>${e.staffId}</td><td>${this.formatCurrency(e.amount)}</td>
                                    <td><button onclick="app.deleteExpenditure(${this.expenditures.length - 1 - idx})" style="border:none; color:red; cursor:pointer;">Del</button></td></tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }

        renderFilteredGrid(targetDiv, dataToRender) {
            const data = dataToRender || this.inventory;
            const locations = [...new Set(data.map(i => i.loc))];
            
            targetDiv.innerHTML = ''; // Clear first
            
            if(locations.length === 0) {
                targetDiv.innerHTML = "<p style='padding:20px; color:#999'>No properties match.</p>";
                return;
            }

            locations.forEach(loc => {
                const section = document.createElement('div');
                section.className = 'location-section';
                section.innerHTML = `<div class="location-header"><div class="location-title">${loc}</div></div><div class="cards-grid"></div>`;
                const grid = section.querySelector('.cards-grid');
                data.filter(i => i.loc === loc).forEach(p => grid.appendChild(this.createCard(p)));
                targetDiv.appendChild(section);
            });
        }

        createCard(prop) {
            const isOcc = prop.status === 'occupied';
            const div = document.createElement('div');
            div.className = 'property-card';
            let btnHtml = isOcc ? (this.role === 'staff' ? `<button class="action-btn btn-checkout" onclick="app.checkout('${prop.id}')">Check Out</button>` : '') : (this.role === 'staff' ? `<button class="action-btn btn-book" onclick="app.openBookingModal('single', '${prop.id}')">Book Unit</button>` : '');
            div.innerHTML = `<div class="status-stripe ${isOcc ? 'status-booked' : 'status-avail'}"></div>
                <div class="card-content">
                    <div class="prop-name">${prop.name}</div>
                    <div class="prop-price">${this.formatCurrency(prop.price)}<span>/night</span></div>
                    ${isOcc ? `<div class="guest-info"><strong>${prop.guestName}</strong></div>` : ''} ${btnHtml}
                </div>`;
            return div;
        }

        addExpenditure() {
            const amt = parseFloat(document.getElementById('expAmt').value);
            const sid = document.getElementById('expStaffId').value;
            const scope = document.getElementById('expUnit').value;
            if(!amt || !sid) return;
            this.expenditures.push({
                amount: amt, date: document.getElementById('expDate').value,
                category: document.getElementById('expCat').value,
                unitId: scope, location: scope.includes('loc:') ? scope.split('loc:')[1] : 'global',
                description: document.getElementById('expDesc').value, staffId: sid
            });
            this.saveLocalData();
        }

        addRefund() {
            const guest = document.getElementById('refGuest').value;
            const amt = parseFloat(document.getElementById('refAmount').value);
            const reason = document.getElementById('refReason').value;
            const staff = document.getElementById('refStaffId').value;
            const date = document.getElementById('refDate').value;

            if(!guest || isNaN(amt) || !reason) return alert("Please fill all fields");

            this.refunds.push({
                date, guest, amount: amt, reason, staffId: staff
            });
            
            this.saveLocalData();
            alert("Refund request submitted successfully.");
            // Clear form
            document.getElementById('refGuest').value = '';
            document.getElementById('refAmount').value = '';
            document.getElementById('refReason').value = '';
        }

        requestRole(r) {
            if(r === 'staff') { this.setRole('staff'); return; }
            this.pendingRole = r;
            document.getElementById('pinModal').style.display = 'flex';
            setTimeout(() => document.getElementById('pinModal').classList.add('show'), 10);
            setTimeout(() => document.getElementById('rolePinInput').focus(), 50); 
        }

        verifyPin() {
            const p = document.getElementById('rolePinInput').value;
            if(p === this.rolePins[this.pendingRole]) { 
                this.setRole(this.pendingRole); 
                this.closeModal(); 
            } else { 
                alert("Incorrect Access PIN"); 
            }
        }
        
        openTargetModal() {
             document.getElementById('targetModal').style.display = 'flex';
             setTimeout(() => document.getElementById('targetModal').classList.add('show'), 10);
        }
        
        saveTarget() {
            const loc = document.getElementById('targetLoc').value;
            const month = document.getElementById('targetMonth').value; // YYYY-MM
            const val = parseFloat(document.getElementById('targetVal').value);
            
            if(loc && val && month) {
                // Store with key Location_YYYY-MM
                const key = `${loc}_${month}`;
                this.targets[key] = val;
                this.saveLocalData();
                this.closeModal();
                alert(`Target for ${loc} (${month}) updated to ${this.formatCurrency(val)}`);
            } else {
                alert("Please select location, month, and amount.");
            }
        }

        setRole(r) { this.role = r; this.render(); }
        
        setStaffTab(t) { 
            this.activeStaffTab = t; 
            this.render(); 
            if(t === 'map') setTimeout(() => this.initMap('staffMap'), 500);
        }
        
        setMgmtTab(t) { this.activeMgmtTab = t; this.render(); }
        deleteExpenditure(idx) { this.expenditures.splice(idx,1); this.saveLocalData(); }
        formatCurrency(n) { return "‚Ç¶" + Math.round(n).toLocaleString(); }
        updateDate(t,v) { t==='from'?this.dateFrom=v:this.dateTo=v; this.render(); }
        updateMgmtFilter(v) { this.managementFilter = v; this.render(); }
        updateFilter(t, v) { this.filters[t] = v; this.render(); }
        updateSort(v) { this.sortBy = v; this.render(); }
        updateSyncUI(s) {
            const dot = document.getElementById('syncDot');
            dot.className = `sync-dot ${s === 'online' ? 'online' : s === 'syncing' ? 'syncing' : ''}`;
        }
        closeModal() { document.querySelectorAll('.modal').forEach(m => { m.classList.remove('show'); setTimeout(()=>m.style.display='none',300); }); }

        openBookingModal(mode, id) {
            this.activeModalMode = mode;
            this.activeModalPropId = id;
            document.getElementById('bookingModal').style.display = 'flex';
            setTimeout(() => document.getElementById('bookingModal').classList.add('show'), 10);
            this.calcTotal();
        }

        calcTotal() {
            const d1 = new Date(document.getElementById('checkInDate').value);
            const d2 = new Date(document.getElementById('checkOutDate').value);
            const nights = Math.max(1, Math.ceil((d2 - d1) / 86400000));
            document.getElementById('nightCount').innerText = nights;
            const p = this.inventory.find(i => i.id === this.activeModalPropId);
            const total = (p ? p.price : 0) * nights;
            document.getElementById('modalTotal').innerText = this.formatCurrency(total);
            document.getElementById('actualPaid').value = total;
        }

        confirmBooking() {
            const p = this.inventory.find(i => i.id === this.activeModalPropId);
            const paid = parseFloat(document.getElementById('actualPaid').value);
            const guest = document.getElementById('guestName').value;
            if(!p || !guest || !paid) return;
            p.status = 'occupied';
            p.guestName = guest;
            this.transactions.push({ date: new Date().toISOString().split('T')[0], propId: p.id, amount: paid, guest });
            this.saveLocalData();
            this.closeModal();
        }

        checkout(id) {
            const p = this.inventory.find(i => i.id === id);
            p.status = 'available';
            this.saveLocalData();
        }
    }
    const app = new AmadaApp();
</script>
</body>
</html>
